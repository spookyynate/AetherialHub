-- Dynamic ESP Line Script (LocalScript)

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")
local Player = Players.LocalPlayer

-- Create the GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ESPGui"
screenGui.Parent = Player.PlayerGui

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0.3, 0, 0.3, 0)
frame.Position = UDim2.new(0.35, 0, 0.35, 0)
frame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
frame.BorderSizePixel = 0
frame.Parent = screenGui

local enableButton = Instance.new("TextButton")
enableButton.Size = UDim2.new(0.4, 0, 0.2, 0)
enableButton.Position = UDim2.new(0.1, 0, 0.2, 0)
enableButton.BackgroundColor3 = Color3.fromRGB(128, 0, 128)  -- Purple color
enableButton.Text = "Enable ESP"
enableButton.TextColor3 = Color3.fromRGB(255, 255, 255)  -- White text
enableButton.TextScaled = true
enableButton.BorderSizePixel = 0
enableButton.Parent = frame

local disableButton = Instance.new("TextButton")
disableButton.Size = UDim2.new(0.4, 0, 0.2, 0)
disableButton.Position = UDim2.new(0.1, 0, 0.6, 0)
disableButton.BackgroundColor3 = Color3.fromRGB(128, 0, 128)  -- Purple color
disableButton.Text = "Disable ESP"
disableButton.TextColor3 = Color3.fromRGB(255, 255, 255)  -- White text
disableButton.TextScaled = true
disableButton.BorderSizePixel = 0
disableButton.Parent = frame

-- ESP Variables
local espEnabled = false
local lines = {}

-- Function to create or update the line
local function updateLine(startPos, endPos, color, line)
    if not line then
        line = Instance.new("Part")
        line.Anchored = true
        line.CanCollide = false
        line.BrickColor = BrickColor.new(color)
        line.Material = Enum.Material.SmoothPlastic
        line.Parent = Workspace
    end

    -- Calculate the midpoint for correct orientation
    local midpoint = (startPos + endPos) / 2
    local size = Vector3.new(0.1, (startPos - endPos).Magnitude, 0.1)
    
    line.Size = size
    line.CFrame = CFrame.new(midpoint, endPos) * CFrame.new(0, 0, -size.Y / 2)
    return line
end

-- Function to enable ESP for a specific player
local function enableESPForPlayer(targetPlayer)
    local targetCharacter = targetPlayer.Character
    local myCharacter = Player.Character
    if not targetCharacter or not myCharacter then return end

    local targetHead = targetCharacter:FindFirstChild("Head")
    local myHead = myCharacter:FindFirstChild("Head")
    if not targetHead or not myHead then return end

    local targetHeadPos = targetHead.Position
    local myHeadPos = myHead.Position

    -- Create or update the line connecting to this player
    if not lines[targetPlayer.UserId] then
        lines[targetPlayer.UserId] = Instance.new("Part")
        lines[targetPlayer.UserId].Anchored = true
        lines[targetPlayer.UserId].CanCollide = false
        lines[targetPlayer.UserId].BrickColor = BrickColor.new("Bright red")
        lines[targetPlayer.UserId].Material = Enum.Material.SmoothPlastic
        lines[targetPlayer.UserId].Parent = Workspace
    end

    lines[targetPlayer.UserId] = updateLine(myHeadPos, targetHeadPos, "Bright red", lines[targetPlayer.UserId])
end

-- Function to remove ESP for a specific player
local function removeESPForPlayer(targetPlayer)
    local line = lines[targetPlayer.UserId]
    if line then
        line:Destroy()
        lines[targetPlayer.UserId] = nil
    end
end

-- Function to toggle ESP for all players
local function toggleESP()
    espEnabled = not espEnabled
    if espEnabled then
        enableButton.Text = "ESP Enabled"
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= Player then
                enableESPForPlayer(player)
            end
        end
    else
        enableButton.Text = "Enable ESP"
        for _, player in ipairs(Players:GetPlayers()) do
            removeESPForPlayer(player)
        end
    end
end

-- Connect buttons to functions
enableButton.MouseButton1Click:Connect(function()
    if not espEnabled then
        toggleESP()
    end
end)

disableButton.MouseButton1Click:Connect(function()
    if espEnabled then
        toggleESP()
    end
end)

-- Continuously update lines
RunService.RenderStepped:Connect(function()
    if espEnabled then
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= Player then
                enableESPForPlayer(player)
            end
        end
    end
end)
