-- Dynamic ESP Line Script (LocalScript)

local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local Player = Players.LocalPlayer

-- Create the GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ESPGui"
screenGui.Parent = Player.PlayerGui

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0.3, 0, 0.3, 0)
frame.Position = UDim2.new(0.35, 0, 0.35, 0)
frame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
frame.BorderSizePixel = 0
frame.Parent = screenGui

local enableButton = Instance.new("TextButton")
enableButton.Size = UDim2.new(0.4, 0, 0.2, 0)
enableButton.Position = UDim2.new(0.1, 0, 0.2, 0)
enableButton.BackgroundColor3 = Color3.fromRGB(128, 0, 128)  -- Purple color
enableButton.Text = "Enable ESP"
enableButton.TextColor3 = Color3.fromRGB(255, 255, 255)  -- White text
enableButton.TextScaled = true
enableButton.BorderSizePixel = 0
enableButton.Parent = frame

local disableButton = Instance.new("TextButton")
disableButton.Size = UDim2.new(0.4, 0, 0.2, 0)
disableButton.Position = UDim2.new(0.1, 0, 0.6, 0)
disableButton.BackgroundColor3 = Color3.fromRGB(128, 0, 128)  -- Purple color
disableButton.Text = "Disable ESP"
disableButton.TextColor3 = Color3.fromRGB(255, 255, 255)  -- White text
disableButton.TextScaled = true
disableButton.BorderSizePixel = 0
disableButton.Parent = frame

-- ESP Variables
local espEnabled = false
local lines = {}

-- Function to draw a line from a start position to an end position
local function updateLine(startPos, endPos, color, line)
    if not line then
        line = Instance.new("Part")
        line.Anchored = true
        line.CanCollide = false
        line.BrickColor = BrickColor.new(color)
        line.Material = Enum.Material.SmoothPlastic
        line.Parent = Workspace
    end

    line.Size = Vector3.new(0.1, (startPos - endPos).Magnitude, 0.1)
    line.CFrame = CFrame.new(startPos, endPos) * CFrame.new(0, 0, -line.Size.Y / 2)
end

-- Function to enable ESP for a specific player
local function enableESPForPlayer(targetPlayer)
    local character = targetPlayer.Character
    if not character or not character:FindFirstChild("HumanoidRootPart") then return end

    local head = character:FindFirstChild("Head")
    if not head then return end

    local headPos = head.Position
    local myCharacter = Player.Character
    if not myCharacter or not myCharacter:FindFirstChild("Head") then return end

    local myHeadPos = myCharacter.Head.Position

    -- Create a new line if it doesn't exist, or update the existing one
    if not lines[targetPlayer.UserId] then
        local line = Instance.new("Part")
        line.Anchored = true
        line.CanCollide = false
        line.BrickColor = BrickColor.new("Bright red")
        line.Material = Enum.Material.SmoothPlastic
        line.Parent = Workspace
        lines[targetPlayer.UserId] = line
    end

    updateLine(myHeadPos, headPos, "Bright red", lines[targetPlayer.UserId])
end

-- Function to remove ESP for a specific player
local function removeESPForPlayer(targetPlayer)
    local line = lines[targetPlayer.UserId]
    if line then
        line:Destroy()
        lines[targetPlayer.UserId] = nil
    end
end

-- Function to toggle ESP for all players
local function toggleESP()
    espEnabled = not espEnabled
    if espEnabled then
        enableButton.Text = "ESP Enabled"
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= Player then
                enableESPForPlayer(player)
            end
        end
    else
        enableButton.Text = "Enable ESP"
        for _, player in ipairs(Players:GetPlayers()) do
            removeESPForPlayer(player)
        end
    end
end

-- Connect buttons to functions
enableButton.MouseButton1Click:Connect(function()
    if not espEnabled then
        toggleESP()
    end
end)

disableButton.MouseButton1Click:Connect(function()
    if espEnabled then
        toggleESP()
    end
end)

-- Update ESP lines when players join or respawn
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function()
        if espEnabled then
            enableESPForPlayer(player)
        end
    end)
end)

-- Continuously update lines
game:GetService("RunService").RenderStepped:Connect(function()
    if espEnabled then
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= Player then
                enableESPForPlayer(player)
            end
        end
    end
end)
